name: Adopets daily monitoring

on:
  schedule:
    # Every day at 10:00 UTC (adjust if you want)
    - cron: "0 10 * * *"
  workflow_dispatch: {}

permissions:
  contents: write  # allow the workflow to commit snapshots back to the repo

jobs:
  daily-monitoring:
    runs-on: ubuntu-latest

    env:
      AAC_EMAIL_FROM: ${{ secrets.AAC_EMAIL_FROM }}
      AAC_EMAIL_TO: ${{ secrets.AAC_EMAIL_TO }}
      AAC_EMAIL_USER: ${{ secrets.AAC_EMAIL_USER }}
      AAC_EMAIL_PASS: ${{ secrets.AAC_EMAIL_PASS }}
      AAC_EMAIL_SUBJECT_PREFIX: ${{ secrets.AAC_EMAIL_SUBJECT_PREFIX }}
      ADOPETS_API_TOKEN: ${{ secrets.ADOPETS_API_TOKEN }}
      
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 1) Take today's snapshot
      - name: Run snapshot script (today's snapshot)
        run: |
          python fetch_adopets_snapshot.py

      # 2) Commit new snapshot immediately, so it's preserved even if later steps fail
      - name: Commit new snapshot
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage new snapshots (latest_diff.json should be ignored by .gitignore)
          git add snapshots/*.json || true

          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "No snapshot changes to commit."
          else
            git commit -m "Add snapshot for $(date -u +'%Y-%m-%d')"
            git push
          fi

      # 3) Build diff vs previous snapshot (uses local working copy, commit timing doesn't matter)
      - name: Build diff vs previous snapshot
        run: |
          python - << 'PY'
          import json
          from pathlib import Path
          from compare_snapshots import compare_snapshots

          snap_dir = Path("snapshots")

          # Only keep REAL snapshots: timestamp files starting with a digit.
          snap_files = [
              p for p in snap_dir.glob("*.json")
              if p.name[0].isdigit()
          ]

          snaps = sorted(snap_files)

          if len(snaps) < 2:
              print("Not enough snapshots to compare; skipping diff/email.")
              raise SystemExit(0)

          old_path = snaps[-2]
          new_path = snaps[-1]

          diff = compare_snapshots(old_path, new_path)

          out_path = snap_dir / "latest_diff.json"
          out_path.write_text(
              json.dumps(diff, indent=2, ensure_ascii=False),
              encoding="utf-8"
          )
          print(f"Created diff for {old_path} -> {new_path} at {out_path}")
          PY
          
      # 4) Cross-check removals vs outcomes
      - name: Cross-check removed profiles vs outcomes
        run: |
          if [ -f "snapshots/latest_diff.json" ]; then
            python crosscheck_removals.py snapshots/latest_diff.json
          else
            echo "No diff file found; skipping cross-check."
          fi

      # 5) Send email summary
      - name: Send email summary
        run: |
          if [ -f "snapshots/latest_diff.json" ]; then
            python email_adopets_changes.py snapshots/latest_diff.json
          else
            echo "No diff file found; skipping email."
          fi
